--// Fixed ESP Library
--// Based on kiriot22 ESP
--// Fixes:
--// 1. Long-lived ESP lag (auto cleanup + proper disconnects)
--// 2. Multi-instancing (duplicate names supported)

local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Camera = workspace.CurrentCamera

local ESP = {}
ESP.Enabled = true
ESP.Objects = {}         -- [Instance] = box
ESP.InstanceMap = {}     -- [UniqueId] = box
ESP.LifeSpan = 10        -- seconds before stale ESP auto-removes

--// Utility
local function GetId(inst)
    return tostring(inst:GetDebugId())
end

local function NewDrawing(class)
    local obj = Drawing.new(class)
    obj.Visible = false
    return obj
end

--// Box class
local Box = {}
Box.__index = Box

function Box.new(object, options)
    local self = setmetatable({}, Box)

    self.Object = object
    self.Id = GetId(object)
    self.Options = options or {}
    self.LastUpdate = tick()

    self.Box = NewDrawing("Square")
    self.Box.Thickness = 1
    self.Box.Filled = false

    self.NameText = NewDrawing("Text")
    self.NameText.Center = true
    self.NameText.Outline = true
    self.NameText.Size = 13

    self.Connection = RunService.RenderStepped:Connect(function()
        self:Update()
    end)

    return self
end

function Box:Remove()
    if self.Connection then
        self.Connection:Disconnect()
        self.Connection = nil
    end

    for _, d in ipairs({ self.Box, self.NameText }) do
        if d then
            d.Visible = false
            d:Remove()
        end
    end

    ESP.InstanceMap[self.Id] = nil
    ESP.Objects[self.Object] = nil
end

function Box:Update()
    if not ESP.Enabled then
        self.Box.Visible = false
        self.NameText.Visible = false
        return
    end

    if not self.Object or not self.Object.Parent then
        return self:Remove()
    end

    local model = self.Object:IsA("Model") and self.Object or self.Object:FindFirstAncestorOfClass("Model")
    if not model then
        return self:Remove()
    end

    local root = model.PrimaryPart or model:FindFirstChild("HumanoidRootPart")
    if not root then
        return self:Remove()
    end

    local pos, onscreen = Camera:WorldToViewportPoint(root.Position)
    if not onscreen then
        self.Box.Visible = false
        self.NameText.Visible = false
        return
    end

    self.LastUpdate = tick()

    local distance = (Camera.CFrame.Position - root.Position).Magnitude
    local size = math.clamp(3000 / distance, 20, 300)

    self.Box.Size = Vector2.new(size, size * 1.4)
    self.Box.Position = Vector2.new(pos.X - self.Box.Size.X / 2, pos.Y - self.Box.Size.Y / 2)
    self.Box.Color = self.Options.Color or Color3.fromRGB(255, 255, 255)
    self.Box.Visible = true

    self.NameText.Text = model.Name
    self.NameText.Position = Vector2.new(pos.X, pos.Y - self.Box.Size.Y / 2 - 14)
    self.NameText.Color = self.Box.Color
    self.NameText.Visible = true
end

--// Add ESP
function ESP:Add(object, options)
    if ESP.Objects[object] then
        return ESP.Objects[object]
    end

    local box = Box.new(object, options)
    ESP.Objects[object] = box
    ESP.InstanceMap[box.Id] = box

    return box
end

--// Remove ESP
function ESP:Remove(object)
    local box = ESP.Objects[object]
    if box then
        box:Remove()
    end
end

--// Global cleanup (fixes lag over time)
RunService.RenderStepped:Connect(function()
    local now = tick()
    for _, box in pairs(ESP.InstanceMap) do
        if now - box.LastUpdate > ESP.LifeSpan then
            box:Remove()
        end
    end
end)

--// Toggle
function ESP:Toggle(state)
    ESP.Enabled = state
end

return ESP
